#!/usr/bin/env bash
set -e

echo ""
echo "Living Architecture ━━━━━━━━━━━━━━━━━━━"
echo ""

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py|js|ts|jsx|tsx)$' || true)

if [ -n "$STAGED_FILES" ]; then
  VIOLATION=0
  
  while IFS= read -r file; do
    if [[ "$file" =~ src/domain/ ]]; then
      if grep -qE "from.*(database|api|integrations)" "$file" 2>/dev/null || \
         grep -qE "import.*(database|api|integrations)" "$file" 2>/dev/null || \
         grep -qE "require.*['\"].*(database|api|integrations)" "$file" 2>/dev/null; then
        echo "  ✗ Dependency violation"
        echo ""
        echo "  $file → database/api/integrations"
        echo ""
        echo "  R1 cannot depend on R2/R3/R4"
        echo ""
        echo "  → Define interface in domain"
        echo "  → Implement in database"
        echo ""
        echo "  Guide: .living-arch/SYSTEM.md"
        echo ""
        VIOLATION=1
      fi
    elif [[ "$file" =~ src/database/ ]]; then
      if grep -qE "from.*(api|integrations)" "$file" 2>/dev/null || \
         grep -qE "import.*(api|integrations)" "$file" 2>/dev/null || \
         grep -qE "require.*['\"].*(api|integrations)" "$file" 2>/dev/null; then
        echo "  ✗ Dependency violation"
        echo ""
        echo "  $file → api/integrations"
        echo ""
        echo "  R2 cannot depend on R3/R4"
        echo ""
        echo "  → Move orchestration to API layer"
        echo "  → Pass services as parameters"
        echo ""
        echo "  Guide: .living-arch/SYSTEM.md"
        echo ""
        VIOLATION=1
      fi
    elif [[ "$file" =~ src/api/ ]]; then
      if grep -qE "from.*integrations" "$file" 2>/dev/null || \
         grep -qE "import.*integrations" "$file" 2>/dev/null || \
         grep -qE "require.*['\"].*integrations" "$file" 2>/dev/null; then
        echo "  ✗ Dependency violation"
        echo ""
        echo "  $file → integrations"
        echo ""
        echo "  R3 cannot depend on R4"
        echo ""
        echo "  → Move adapter to integrations"
        echo "  → Call from integration layer"
        echo ""
        echo "  Guide: .living-arch/SYSTEM.md"
        echo ""
        VIOLATION=1
      fi
    fi
  done <<< "$STAGED_FILES"
  
  if [ $VIOLATION -eq 1 ]; then
    echo "━━━━━━━━━━━━━━━━━━━━━━━ Living Architecture"
    echo ""
    exit 1
  fi
fi

# Silent on success - post-commit will handle output

exit 0
